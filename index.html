<!DOCTYPE html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>메이플 캐릭터 조회기</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #result pre { background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; }
    .world-icon { width: 24px; height: 24px; margin-right: 6px; vertical-align: middle; }
    .v-icon-wrapper {
    width: 80px;
    text-align: center;
  }
  .v-icon-bg {
    position: relative;
    width: 80px;
    height: 80px;
    margin: 0 auto;
  }
  .v-icon-bg img.polygon-bg {
    width: 100%;
  }
  .v-icon-bg img.skill-icon {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  </style>
</head>
<body>
  <div class="container">
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <button class="nav-link active" onclick="openTab('character')">캐릭터 조회</button>
      </li>
    </ul>

    <div id="character" class="tab-content active">
      <div class="mb-3">
        <label for="world" class="form-label">월드 선택</label>
        <select id="world" class="form-select">
  <option value="스카니아">스카니아</option>
  <option value="루나">루나</option>
  <option value="엘리시움">엘리시움</option>
  <option value="크로아">크로아</option>
  <option value="유니온">유니온</option>
  <option value="제니스">제니스</option>
  <option value="아케인">아케인</option>
</select>
      </div>
      <div class="mb-3">
        <label for="nickname" class="form-label">캐릭터 닉네임</label>
        <input type="text" id="nickname" class="form-control" placeholder="예: 루나링">
      </div>
      <div class="mb-3">
        <label for="apiKey" class="form-label">넥슨 Open API 토큰</label>
        <input type="password" id="apiKey" class="form-control" placeholder="발급받은 API 토큰">
      </div>
      <button class="btn btn-primary" onclick="searchCharacter()">검색</button>
      <div id="result" class="mt-4"></div>
    </div>
  </div>

  <script>
    function openTab(tabId) {
      const tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');

      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => link.classList.remove('active'));
      event.target.classList.add('active');
    }

    function formatDate(utcString) {
      if (!utcString) return '-';
      const date = new Date(utcString);
      const offsetDate = new Date(date.getTime() + 9 * 60 * 60 * 1000); // UTC+9
      return offsetDate.toISOString().replace('T', ' ').substring(0, 19);
    }

    function formatNumber(num) {
      return Number(num).toLocaleString();
    }

    function formatKoreanExp(num) {
      const units = ['', '만', '억', '조', '경'];
      const parts = [];
      let value = Number(num);
      let unitIndex = 0;

      while (value > 0 && unitIndex < units.length) {
        const part = value % 10000;
        if (part > 0) {
          parts.unshift(`${part.toLocaleString()}${units[unitIndex]}`);
        }
        value = Math.floor(value / 10000);
        unitIndex++;
      }

      return `(${parts.join(' ')})`;
    }

    async function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function searchCharacter() {
      const world = document.getElementById('world').value;
      const nickname = document.getElementById('nickname').value;
      const apiKey = document.getElementById('apiKey').value;

      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';

      if (!world || !nickname || !apiKey) {
        resultDiv.innerHTML = '<div class="alert alert-warning">모든 필드를 입력해주세요.</div>';
        return;
      }

      resultDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

      try {
        const ocidResponse = await fetch(`https://open.api.nexon.com/maplestorym/v1/id?character_name=${encodeURIComponent(nickname)}&world_name=${encodeURIComponent(world)}`, {
          headers: { 'x-nxopen-api-key': apiKey }
        });
        const ocidData = await ocidResponse.json();
        const ocid = ocidData.ocid;

        const endpoints = [
          'guild',
          'basic',
          // 'item-equipment',
          'stat',
          // 'beauty-equipment',
          // 'pet-equipment',
          // 'skill-equipment',
          'vmatrix'
        ];

        let html = '';
let guildName = '';
let characterJob = '';
        for (const endpoint of endpoints) {
          resultDiv.innerHTML = `<div class="spinner-border text-info" role="status"><span class="visually-hidden">Loading...</span></div><p>불러오는 중: /character/${endpoint}</p>`;

          const res = await fetch(`https://open.api.nexon.com/maplestorym/v1/character/${endpoint}?ocid=${ocid}`, {
            headers: { 'x-nxopen-api-key': apiKey }
          });
          const data = await res.json();

          if (endpoint === 'guild') {
            guildName = data.guild_name || '';
          }

          if (endpoint === 'basic') {
  characterJob = data.character_class || data.character_job_name || '';
  const genderKo = data.character_gender === 'Male' ? '남' : data.character_gender === 'Female' ? '여' : data.character_gender;
  const formattedExp = `${formatNumber(data.character_exp)} ${formatKoreanExp(data.character_exp)}`;
  html += `
              <div class="card mb-4">
                <div class="card-body">
                  <h5 class="card-title">${data.character_name}</h5>
                  <img src="images/world/${data.world_name}.png" alt="${data.world_name}" class="world-icon">${data.world_name} | Lv.${data.character_level} | ${data.character_job_name}${guildName ? ` | ${guildName}` : ''}</h6>
                  <p class="card-text">
                    성별 : ${genderKo}<br>
                    생성일 : ${formatDate(data.character_date_create)}<br>
                    경험치 : ${formattedExp}<br>
                    최근 접속 시간 : ${formatDate(data.character_date_last_login)}<br>
                    최근 접속종료 시간 : ${formatDate(data.character_date_last_logout)}
                  </p>
                </div>
              `;
          } else if (endpoint === 'stat') {
  html += `
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">스탯 정보</h5>
        <ul class="list-group list-group-flush">
          ${data.stat.map(stat => `<li class=\"list-group-item\">${stat.stat_name} : ${formatNumber(stat.stat_value)}</li>`).join('')}
        </ul>
      </div>
    `;
} else if (endpoint === 'vmatrix') {
  const cores = data.character_v_core_equipment;
  let vMatrixHTML = `
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">V 매트릭스</h5>
        <div class="d-flex flex-wrap gap-3">
  `;

  let enhancementMap = {};

  for (const core of cores) {
    const { v_core_type, v_core_level, slot_level, v_core_name } = core;
    const totalLevel = v_core_level + slot_level;

    if (v_core_type === 'Skill') {
      const icon = getSkillImageTag(v_core_name, characterJob, 'Skill');
      vMatrixHTML += `
        <div class="text-center">
          <img src="images/polygon.png" alt="육각형" width="80"><br>
          <div>LV.${totalLevel}</div>
          ${icon}
          <div>${v_core_name}</div>
        </div>
      `;
    } else if (v_core_type === 'Special') {
      const icon = getSkillImageTag(v_core_name, characterJob, 'Special');
      vMatrixHTML += `
        <div class="text-center">
          <img src="images/polygon.png" alt="육각형" width="80"><br>
          <div>LV.${v_core_level}</div>
          ${icon}
          <div>${v_core_name}</div>
        </div>
      `;
    } else if (v_core_type === 'Enhancement') {
      const skills = [
        core.v_core_skill_name_1,
        core.v_core_skill_name_2,
        core.v_core_skill_name_3
      ].filter(n => n !== '(Unknown)');
      for (const name of skills) {
        if (!enhancementMap[name]) enhancementMap[name] = 0;
        enhancementMap[name] += totalLevel;
      }
    }
  }

  for (const [skillName, level] of Object.entries(enhancementMap)) {
    const icon = getSkillImageTag(skillName, characterJob, 'Enhancement');
    vMatrixHTML += `
      <div class="text-center">
        <img src="images/polygon.png" alt="육각형" width="80"><br>
        <div>LV.${Math.min(level, 60)}</div>
        ${icon}
        <div>${skillName}</div>
      </div>
    `;
  }

  const enhancementTotal = Object.values(enhancementMap).reduce((a, b) => a + Math.min(b, 60), 0);

  vMatrixHTML += `
        </div>
        <hr>
        <div><strong>강화코어 총합 레벨:</strong> ${enhancementTotal}</div>
      </div>
    </div>
  `;

  html += vMatrixHTML;
} else if (endpoint !== 'guild') {
  html += `<h5>/character/${endpoint} 결과</h5><pre>${JSON.stringify(data, null, 2)}</pre>`;
          }

          await delay(500);
        }

        resultDiv.innerHTML = html;

      } catch (error) {
        resultDiv.innerHTML = '<div class="alert alert-danger">캐릭터 정보를 불러오지 못했습니다.</div>';
        console.error(error);
      }
    }
  
    function getJobDetail(job) {
      const detail = [];
      const categoryMap = [
        { group: ['히어로', '팔라딘', '다크나이트', '비숍', '아크메이지(불,독)', '아크메이지(썬,콜)', '보우마스터', '신궁', '패스파인더', '나이트로드', '섀도어', '듀얼블레이드', '캡틴', '바이퍼', '캐논슈터'], tag: '모험가' },
        { group: ['소울마스터', '미하일', '플레임위자드', '윈드브레이커', '나이트워커', '스트라이커'], tag: '시그너스기사단' },
        { group: ['아란', '에반', '메르세데스', '팬텀', '루미너스', '은월'], tag: '영웅' },
        { group: ['블래스터', '배틀메이지', '와일드헌터', '제논', '메카닉'], tag: '레지스탕스' },
        { group: ['데몬슬레이어', '데몬어벤져'], tag: '데몬' },
        { group: ['카이저', '카데나', '카인', '엔젤릭버스터'], tag: '노바' },
        { group: ['아델', '일리움', '칼리', '아크'], tag: '레프' },
        { group: ['라라', '호영'], tag: '아니마' },
        { group: ['제로'], tag: '초월자' },
        { group: ['키네시스'], tag: '프렌즈 월드' }
      ];
      const classMap = [
        { group: ['히어로', '팔라딘', '다크나이트', '소울마스터', '미하일', '블래스터', '데몬슬레이어', '데몬어벤져', '아란', '카이저', '아델', '제로', '에릴'], tag: '전사' },
        { group: ['비숍', '아크메이지(불,독)', '아크메이지(썬,콜)', '플레임위자드', '에반', '루미너스', '배틀메이지', '일리움', '라라', '키네시스', '시아'], tag: '마법사' },
        { group: ['보우마스터', '신궁', '패스파인더', '윈드브레이커', '메르세데스', '와일드헌터', '카인'], tag: '궁수' },
        { group: ['나이트로드', '섀도어', '듀얼블레이드', '나이트워커', '팬텀', '카데나', '칼리', '호영'], tag: '도적' },
        { group: ['캡틴', '바이퍼', '캐논슈터', '스트라이커', '은월', '메카닉', '엔젤릭버스터', '아크'], tag: '해적' },
        { group: ['제논'], tag: '도적' },
        { group: ['제논'], tag: '해적' }
      ];
      categoryMap.forEach(({ group, tag }) => { if (group.includes(job)) detail.push(tag); });
      classMap.forEach(({ group, tag }) => { if (group.includes(job)) detail.push(tag); });
      return detail;
    }

    function resolveSkillImage(skillName, job, type) {
      const cleanName = skillName.replace(/:/g, '').split('/')[0];
      const details = Array.from(new Set(getJobDetail(job)));
      const paths = [];

      if (type === 'Skill') {
        paths.push(`images/5차스킬/${job}/스킬코어/${cleanName}`);
        for (const d of details) paths.push(`images/5차스킬/공용스킬/${d}/${cleanName}`);
        paths.push(`images/5차스킬/공용스킬/전체공용/${cleanName}`);
      } else if (type === 'Enhancement') {
        paths.push(`images/5차스킬/${job}/강화코어/${cleanName}`);
      } else if (type === 'Special') {
        paths.push(`images/5차스킬/특수코어/${cleanName}`);
      }

      return paths.flatMap(path => [
  `${encodeURI(path)}.png`,
  `${encodeURI(path)}.webp`
]);
    }

function getSkillImageTag(skillName, job, type) {
  const candidates = resolveSkillImage(skillName, job, type);
  const imgId = `img_${Math.random().toString(36).substring(2)}`;
  const wrapperId = `wrap_${imgId}`;

  const html = `
    <div class="v-icon-wrapper" id="${wrapperId}">
      <div class="v-icon-bg">
        <img src="images/polygon.png" class="polygon-bg" alt="배경">
        <img id="${imgId}" src="images/polygon.png" class="skill-icon" alt="${skillName}">
      </div>
    </div>
  `;

  setTimeout(() => {
    const imgEl = document.getElementById(imgId);
    if (!imgEl) return;

    let index = 0;

    const tryNext = () => {
      if (index >= candidates.length) return;
      const testImg = new Image();
      testImg.onload = () => {
        imgEl.src = candidates[index];
      };
      testImg.onerror = () => {
        index++;
        tryNext();
      };
      testImg.src = candidates[index];
    };

    tryNext();
  }, 0);

  return html;
}

  </script>
</body>
</html>
