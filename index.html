<!DOCTYPE html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë©”ì´í”ŒM ìºë¦­í„° ì¡°íšŒê¸°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #result pre { background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; }
    .world-icon { width: 24px; height: 24px; margin-right: 6px; vertical-align: middle; }
    .v-icon-wrapper {
    width: 80px;
    text-align: center;
  }
  .v-icon-bg {
    position: relative;
    width: 80px;
    height: 80px;
    margin: 0 auto;
  }
  .v-icon-bg img.polygon-bg {
    width: 100%;
  }
  .v-icon-bg img.skill-icon {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  </style>
</head>
<body>
  <div class="container">
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <button class="nav-link active" onclick="openTab('character')">ìºë¦­í„° ì¡°íšŒ</button>
      </li>
    </ul>

    <div id="character" class="tab-content active">
      <div class="mb-3">
        <label for="world" class="form-label">ì›”ë“œ ì„ íƒ</label>
        <select id="world" class="form-select">
  <option value="ìŠ¤ì¹´ë‹ˆì•„">ìŠ¤ì¹´ë‹ˆì•„</option>
  <option value="ë£¨ë‚˜">ë£¨ë‚˜</option>
  <option value="ì—˜ë¦¬ì‹œì›€">ì—˜ë¦¬ì‹œì›€</option>
  <option value="í¬ë¡œì•„">í¬ë¡œì•„</option>
  <option value="ìœ ë‹ˆì˜¨">ìœ ë‹ˆì˜¨</option>
  <option value="ì œë‹ˆìŠ¤">ì œë‹ˆìŠ¤</option>
  <option value="ì•„ì¼€ì¸">ì•„ì¼€ì¸</option>
</select>
      </div>
      <div class="mb-3">
        <label for="nickname" class="form-label">ìºë¦­í„° ë‹‰ë„¤ì„</label>
        <input type="text" id="nickname" class="form-control" placeholder="ì˜ˆ: ê³µëµëŒ€ì¥">
      </div>
      <div class="mb-3">
        <label for="apiKey" class="form-label">ë„¥ìŠ¨ Open API í† í°</label>
        <input type="password" id="apiKey" class="form-control" placeholder="ë°œê¸‰ë°›ì€ API í† í°">
      </div>
      <button class="btn btn-primary" onclick="searchCharacter()">ê²€ìƒ‰</button>
      <div id="result" class="mt-4"></div>
    </div>
  </div>

  <script>
    function openTab(tabId) {
      const tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');

      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => link.classList.remove('active'));
      event.target.classList.add('active');
    }

    function formatDate(utcString) {
      if (!utcString) return '-';
      const date = new Date(utcString);
      const offsetDate = new Date(date.getTime() + 9 * 60 * 60 * 1000); // UTC+9
      return offsetDate.toISOString().replace('T', ' ').substring(0, 19);
    }

    function formatNumber(num) {
      return Number(num).toLocaleString();
    }

    function formatKoreanExp(num) {
      const units = ['', 'ë§Œ', 'ì–µ', 'ì¡°', 'ê²½'];
      const parts = [];
      let value = Number(num);
      let unitIndex = 0;

      while (value > 0 && unitIndex < units.length) {
        const part = value % 10000;
        if (part > 0) {
          parts.unshift(`${part.toLocaleString()}${units[unitIndex]}`);
        }
        value = Math.floor(value / 10000);
        unitIndex++;
      }

      return `(${parts.join(' ')})`;
    }

    async function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function searchCharacter() {
      const world = document.getElementById('world').value;
      const nickname = document.getElementById('nickname').value;
      const apiKey = document.getElementById('apiKey').value;

      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';

      if (!world || !nickname || !apiKey) {
        resultDiv.innerHTML = '<div class="alert alert-warning">ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
        return;
      }

      resultDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

      try {
        const ocidResponse = await fetch(`https://open.api.nexon.com/maplestorym/v1/id?character_name=${encodeURIComponent(nickname)}&world_name=${encodeURIComponent(world)}`, {
          headers: { 'x-nxopen-api-key': apiKey }
        });
        const ocidData = await ocidResponse.json();
        const ocid = ocidData.ocid;

        const endpoints = [
          'guild',
          'basic',
          // 'item-equipment',
          'stat',
          // 'beauty-equipment',
          // 'pet-equipment',
          // 'skill-equipment',
          'vmatrix'
        ];

        let html = '';
let guildName = '';
let characterJob = '';
        for (const endpoint of endpoints) {
          resultDiv.innerHTML = `<div class="spinner-border text-info" role="status"><span class="visually-hidden">Loading...</span></div><p>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘: /character/${endpoint}</p>`;

          const res = await fetch(`https://open.api.nexon.com/maplestorym/v1/character/${endpoint}?ocid=${ocid}`, {
            headers: { 'x-nxopen-api-key': apiKey }
          });
          const data = await res.json();

          if (endpoint === 'guild') {
            guildName = data.guild_name || '';
          }

          if (endpoint === 'basic') {
  characterJob = data.character_class || data.character_job_name || '';
  const genderKo = data.character_gender === 'Male' ? 'ë‚¨' : data.character_gender === 'Female' ? 'ì—¬' : data.character_gender;
  const formattedExp = `${formatNumber(data.character_exp)} ${formatKoreanExp(data.character_exp)}`;
  html += `
              <div class="card mb-4">
                <div class="card-body">
                  <h5 class="card-title">${data.character_name}</h5>
                  <img src="images/world/${data.world_name}.png" alt="${data.world_name}" class="world-icon">${data.world_name} | Lv.${data.character_level} | ${data.character_job_name}${guildName ? ` | ${guildName}` : ''}</h6>
                  <p class="card-text">
                    ì„±ë³„ : ${genderKo}<br>
                    ìƒì„±ì¼ : ${formatDate(data.character_date_create)}<br>
                    ê²½í—˜ì¹˜ : ${formattedExp}<br>
                    ìµœê·¼ ì ‘ì† ì‹œê°„ : ${formatDate(data.character_date_last_login)}<br>
                    ìµœê·¼ ì ‘ì†ì¢…ë£Œ ì‹œê°„ : ${formatDate(data.character_date_last_logout)}
                  </p>
                </div>
              `;
          } else if (endpoint === 'stat') {
  html += `
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">ìŠ¤íƒ¯ ì •ë³´</h5>
        <ul class="list-group list-group-flush">
          ${data.stat.map(stat => `<li class=\"list-group-item\">${stat.stat_name} : ${formatNumber(stat.stat_value)}</li>`).join('')}
        </ul>
      </div>
    `;
} else if (endpoint === 'vmatrix') {
  const cores = data.character_v_core_equipment;
  let vMatrixHTML = `
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">V ë§¤íŠ¸ë¦­ìŠ¤</h5>
        <div class="d-flex flex-wrap gap-3">
  `;

  let enhancementMap = {};

  for (const core of cores) {
    const { v_core_type, v_core_level, slot_level, v_core_name } = core;
    const totalLevel = v_core_level + slot_level;

    if (v_core_type === 'Skill') {
      const icon = getSkillImageTag(v_core_name, characterJob, 'Skill');
      vMatrixHTML += `
        <div class="text-center">
          <img src="images/polygon.png" alt="ìœ¡ê°í˜•" width="80"><br>
          <div>LV.${totalLevel}</div>
          ${icon}
          <div>${v_core_name}</div>
        </div>
      `;
    } else if (v_core_type === 'Special') {
      const icon = getSkillImageTag(v_core_name, characterJob, 'Special');
      vMatrixHTML += `
        <div class="text-center">
          <img src="images/polygon.png" alt="ìœ¡ê°í˜•" width="80"><br>
          <div>LV.${v_core_level}</div>
          ${icon}
          <div>${v_core_name}</div>
        </div>
      `;
    } else if (v_core_type === 'Enhancement') {
      const skills = [
        core.v_core_skill_name_1,
        core.v_core_skill_name_2,
        core.v_core_skill_name_3
      ].filter(n => n !== '(Unknown)');
      for (const name of skills) {
        if (!enhancementMap[name]) enhancementMap[name] = 0;
        enhancementMap[name] += totalLevel;
      }
    }
  }

  for (const [skillName, level] of Object.entries(enhancementMap)) {
    const icon = getSkillImageTag(skillName, characterJob, 'Enhancement');
    vMatrixHTML += `
      <div class="text-center">
        <img src="images/polygon.png" alt="ìœ¡ê°í˜•" width="80"><br>
        <div>LV.${Math.min(level, 60)}</div>
        ${icon}
        <div>${skillName}</div>
      </div>
    `;
  }

  const enhancementTotal = Object.values(enhancementMap).reduce((a, b) => a + Math.min(b, 60), 0);

  html += vMatrixHTML;
} else if (endpoint !== 'guild') {
  html += `<h5>/character/${endpoint} ê²°ê³¼</h5><pre>${JSON.stringify(data, null, 2)}</pre>`;
          }

          await delay(500);
        }

        resultDiv.innerHTML = html;

      } catch (error) {
        resultDiv.innerHTML = '<div class="alert alert-danger">ìºë¦­í„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
        console.error(error);
      }
    }
  
    function getJobDetail(job) {
      const detail = [];
      const categoryMap = [
        { group: ['íˆì–´ë¡œ', 'íŒ”ë¼ë”˜', 'ë‹¤í¬ë‚˜ì´íŠ¸', 'ë¹„ìˆ', 'ì•„í¬ë©”ì´ì§€(ë¶ˆ,ë…)', 'ì•„í¬ë©”ì´ì§€(ì¬,ì½œ)', 'ë³´ìš°ë§ˆìŠ¤í„°', 'ì‹ ê¶', 'íŒ¨ìŠ¤íŒŒì¸ë”', 'ë‚˜ì´íŠ¸ë¡œë“œ', 'ì„€ë„ì–´', 'ë“€ì–¼ë¸”ë ˆì´ë“œ', 'ìº¡í‹´', 'ë°”ì´í¼', 'ìºë…¼ìŠˆí„°'], tag: 'ëª¨í—˜ê°€' },
        { group: ['ì†Œìš¸ë§ˆìŠ¤í„°', 'ë¯¸í•˜ì¼', 'í”Œë ˆì„ìœ„ìë“œ', 'ìœˆë“œë¸Œë ˆì´ì»¤', 'ë‚˜ì´íŠ¸ì›Œì»¤', 'ìŠ¤íŠ¸ë¼ì´ì»¤'], tag: 'ì‹œê·¸ë„ˆìŠ¤ê¸°ì‚¬ë‹¨' },
        { group: ['ì•„ë€', 'ì—ë°˜', 'ë©”ë¥´ì„¸ë°ìŠ¤', 'íŒ¬í…€', 'ë£¨ë¯¸ë„ˆìŠ¤', 'ì€ì›”'], tag: 'ì˜ì›…' },
        { group: ['ë¸”ë˜ìŠ¤í„°', 'ë°°í‹€ë©”ì´ì§€', 'ì™€ì¼ë“œí—Œí„°', 'ì œë…¼', 'ë©”ì¹´ë‹‰'], tag: 'ë ˆì§€ìŠ¤íƒ•ìŠ¤' },
        { group: ['ë°ëª¬ìŠ¬ë ˆì´ì–´', 'ë°ëª¬ì–´ë²¤ì ¸'], tag: 'ë°ëª¬' },
        { group: ['ì¹´ì´ì €', 'ì¹´ë°ë‚˜', 'ì¹´ì¸', 'ì—”ì ¤ë¦­ë²„ìŠ¤í„°'], tag: 'ë…¸ë°”' },
        { group: ['ì•„ë¸', 'ì¼ë¦¬ì›€', 'ì¹¼ë¦¬', 'ì•„í¬'], tag: 'ë ˆí”„' },
        { group: ['ë¼ë¼', 'í˜¸ì˜'], tag: 'ì•„ë‹ˆë§ˆ' },
        { group: ['ì œë¡œ'], tag: 'ì´ˆì›”ì' },
        { group: ['í‚¤ë„¤ì‹œìŠ¤'], tag: 'í”„ë Œì¦ˆ ì›”ë“œ' }
      ];
      const classMap = [
        { group: ['íˆì–´ë¡œ', 'íŒ”ë¼ë”˜', 'ë‹¤í¬ë‚˜ì´íŠ¸', 'ì†Œìš¸ë§ˆìŠ¤í„°', 'ë¯¸í•˜ì¼', 'ë¸”ë˜ìŠ¤í„°', 'ë°ëª¬ìŠ¬ë ˆì´ì–´', 'ë°ëª¬ì–´ë²¤ì ¸', 'ì•„ë€', 'ì¹´ì´ì €', 'ì•„ë¸', 'ì œë¡œ', 'ì—ë¦´'], tag: 'ì „ì‚¬' },
        { group: ['ë¹„ìˆ', 'ì•„í¬ë©”ì´ì§€(ë¶ˆ,ë…)', 'ì•„í¬ë©”ì´ì§€(ì¬,ì½œ)', 'í”Œë ˆì„ìœ„ìë“œ', 'ì—ë°˜', 'ë£¨ë¯¸ë„ˆìŠ¤', 'ë°°í‹€ë©”ì´ì§€', 'ì¼ë¦¬ì›€', 'ë¼ë¼', 'í‚¤ë„¤ì‹œìŠ¤', 'ì‹œì•„'], tag: 'ë§ˆë²•ì‚¬' },
        { group: ['ë³´ìš°ë§ˆìŠ¤í„°', 'ì‹ ê¶', 'íŒ¨ìŠ¤íŒŒì¸ë”', 'ìœˆë“œë¸Œë ˆì´ì»¤', 'ë©”ë¥´ì„¸ë°ìŠ¤', 'ì™€ì¼ë“œí—Œí„°', 'ì¹´ì¸'], tag: 'ê¶ìˆ˜' },
        { group: ['ë‚˜ì´íŠ¸ë¡œë“œ', 'ì„€ë„ì–´', 'ë“€ì–¼ë¸”ë ˆì´ë“œ', 'ë‚˜ì´íŠ¸ì›Œì»¤', 'íŒ¬í…€', 'ì¹´ë°ë‚˜', 'ì¹¼ë¦¬', 'í˜¸ì˜'], tag: 'ë„ì ' },
        { group: ['ìº¡í‹´', 'ë°”ì´í¼', 'ìºë…¼ìŠˆí„°', 'ìŠ¤íŠ¸ë¼ì´ì»¤', 'ì€ì›”', 'ë©”ì¹´ë‹‰', 'ì—”ì ¤ë¦­ë²„ìŠ¤í„°', 'ì•„í¬'], tag: 'í•´ì ' },
        { group: ['ì œë…¼'], tag: 'ë„ì ' },
        { group: ['ì œë…¼'], tag: 'í•´ì ' }
      ];
      categoryMap.forEach(({ group, tag }) => { if (group.includes(job)) detail.push(tag); });
      classMap.forEach(({ group, tag }) => { if (group.includes(job)) detail.push(tag); });
      return detail;
    }

    function resolveSkillImage(skillName, job, type) {
      const cleanName = skillName.replace(/:/g, '').split('/')[0];
      const details = Array.from(new Set(getJobDetail(job)));
      const paths = [];

      if (type === 'Skill') {
        paths.push(`images/5ì°¨ìŠ¤í‚¬/${job}/ìŠ¤í‚¬ì½”ì–´/${cleanName}`);
        for (const d of details) paths.push(`images/5ì°¨ìŠ¤í‚¬/ê³µìš©ìŠ¤í‚¬/${d}/${cleanName}`);
        paths.push(`images/5ì°¨ìŠ¤í‚¬/ê³µìš©ìŠ¤í‚¬/ì „ì²´ê³µìš©/${cleanName}`);
      } else if (type === 'Enhancement') {
        paths.push(`images/5ì°¨ìŠ¤í‚¬/${job}/ê°•í™”ì½”ì–´/${cleanName}`);
      } else if (type === 'Special') {
        paths.push(`images/5ì°¨ìŠ¤í‚¬/íŠ¹ìˆ˜ì½”ì–´/${cleanName}`);
      }
      console.log('paths : ', paths);

      console.log('flatMap : ', paths.flatMap(path => [
        `${encodeURI(path)}.png`,
        `${encodeURI(path)}.webp`
      ]));

      return paths.flatMap(path => [
        `${encodeURI(path)}.png`,
        `${encodeURI(path)}.webp`
      ]);
    }

function getSkillImageTag(skillName, job, type) {
  const candidates = resolveSkillImage(skillName, job, type);
  const imgId = `img_${Math.random().toString(36).substring(2)}`;
  const wrapperId = `wrap_${imgId}`;

  const html = `
    <div class="v-icon-wrapper" id="${wrapperId}">
      <div class="v-icon-bg">
        <img src="images/polygon.png" class="polygon-bg" alt="ë°°ê²½">
        <img id="${imgId}" src="images/polygon.png" class="skill-icon" alt="${skillName}">
      </div>
    </div>
  `;

  setTimeout(() => {
    const imgEl = document.getElementById(imgId);
    if (!imgEl) {
      console.log('imgEl is not defined')
      return;
    }
    let index = 0;

    const tryNext = () => {
      if (index >= candidates.length) {
        console.warn(`âŒ ëª¨ë“  í›„ë³´ ê²½ë¡œ ì‹¤íŒ¨: ${skillName}`);
        return;
      }

      const url = candidates[index];
      console.log("ğŸ¯ í›„ë³´:", candidates[index]);

      const testImg = new Image();
      testImg.onload = () => {
        console.log("âœ… ì„±ê³µ:", url);
        imgEl.src = url + '?v=' + Date.now();  // ìºì‹œ ë°©ì§€
      };
      testImg.onerror = () => {
        console.warn("âŒ ì‹¤íŒ¨:", url);
        index++;
        tryNext();
      };
      testImg.src = url;
    };

    tryNext();
  }, 100);

  return html;
}


  </script>
  <footer class="text-center mt-5 py-3 bg-light text-muted small">
  <div>
    ë²„ì „: <strong>1.0.0</strong> | ì œì‘: <strong>ê³µëµëŒ€ì¥</strong> | Data based on <a href="https://openapi.nexon.com/" target="_blank" class="text-muted text-decoration-none">NEXON Open API</a>
  </div>
</footer>

</body>
</html>
